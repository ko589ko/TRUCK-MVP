<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>問い合わせ一覧 | トラック運行管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      font-family: 'Noto Sans JP', sans-serif;
      padding: 20px;
      color: #0d47a1;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 24px;
    }
    h2 {
      color: #1565c0;
      margin-bottom: 20px;
    }
    .card {
      border-radius: 8px;
      border: 1px solid #bbdefb;
      background-color: #f9fcff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 10px;
      padding: 10px 14px;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    li {
      border-bottom: 1px solid #e3f2fd;
      padding: 6px 0;
      font-size: 15px;
    }
    .btn-primary {
      background-color: #1976d2;
      border: none;
    }
    .btn-primary:hover {
      background-color: #0d47a1;
    }
  </style>
</head>

<body onload="renderInquiryList()">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>💬 問い合わせ一覧</h2>
      <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">戻る</button>
    </div>

    <div id="inquiryList">読み込み中...</div>
  </div>

  <script>
    async function renderInquiryList() {
      const res = await fetch("/api/messages");
      const list = await res.json();
      const driverGroups = {};
      list.forEach(m => {
        if (!driverGroups[m.driver]) driverGroups[m.driver] = [];
        driverGroups[m.driver].push(m);
      });
      const box = document.getElementById("inquiryList");
      box.innerHTML = Object.keys(driverGroups)
        .map(driver => {
          const msgs = driverGroups[driver]
            .filter(m => m.role === "driver")
            .map(m => `<li>${m.date}：${m.subject ? "【" + m.subject + "】" : ""}${m.message}</li>`)
            .join("");
          return `<div class="card">
                    <h6>👷 ${driver}</h6>
                    <ul>${msgs}</ul>
                    <button class="btn btn-sm btn-primary mt-2" onclick="openChat('${driver}')">返信する</button>
                  </div>`;
        })
        .join("");
    }

    function openChat(driver) {
      location.href = `company_chat.html?driver=${encodeURIComponent(driver)}`;
    }
  </script>

  <script src="script.js"></script>
</body>
</html>
